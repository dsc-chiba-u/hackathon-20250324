# ハッカソン向けRAG検索サンプルスクリプト

## simple_rag.py - 簡易RAG検索ツール

`simple_rag.py`は、Azure AI SearchとAzure OpenAIを使用した基本的なRAG（検索拡張生成）実装の例です。本スクリプトはRAGの基本概念を理解するための参考資料として提供されており、ECサイトの商品情報を検索対象とする設計になっています。

### 基本的な使用方法

```bash
# 基本的な検索と回答生成
python simple_rag.py --query "おすすめのノートパソコンは？"

# 詳細情報を表示（長い説明なども全て表示）
python simple_rag.py --query "おすすめのノートパソコンは？" --verbose

# 検索結果のみを表示（回答生成なし）
python simple_rag.py --query "おすすめのノートパソコンは？" --search-only

# 検索結果数の指定
python simple_rag.py --query "おすすめのノートパソコンは？" --top 10

# カスタムインデックスを指定
python simple_rag.py --query "おすすめのノートパソコンは？" --index "my-index"
```

### コマンドラインオプション

| オプション | 説明 |
|-----------|------|
| `--query`, `-q` | 検索クエリ (必須) |
| `--index`, `-i` | 検索対象のインデックス名 (デフォルト: `unifyd-docs-index`) |
| `--top`, `-t` | 検索結果の最大数 (デフォルト: `3`) |
| `--verbose`, `-v` | 詳細情報を表示（長いテキストフィールドも全て表示） |
| `--search-only`, `-s` | 検索のみを実行し、回答生成を行わない |

これらのオプションは以下のように影響します：

- `--query`: 何を検索するかを指定します。質問文や検索キーワードを入力します。
- `--index`: 使用するAzure AI Searchのインデックス名を指定します。適切なインデックスが設定されていないと検索が失敗します。
- `--top`: 返される検索結果の数を指定します。多くの結果が必要な場合は大きな値を設定できますが、処理時間とトークン消費量が増加します。
- `--verbose`: 設定するとドキュメントの長い説明文なども全て表示します。設定しない場合は自動的に切り詰められます。
- `--search-only`: 設定すると検索結果のみを表示し、OpenAIによる回答生成を行いません。APIキーの消費を抑えたい場合に有効です。

### 主な特徴

1. **シンプルな実装**:
   - RAGシステムの基本的な流れを理解しやすいシンプルなコード構造
   - Azure AI SearchとAzure OpenAI Serviceの基本的な使用方法を解説
   - 詳細なコメントによるコード説明

2. **商品検索の例**:
   - 商品名、説明、カテゴリ、ブランドなどを検索対象とする設計
   - 検索結果を適切な形式でLLMに提供するコンテキスト構築
   - 商品情報に基づいた回答生成のプロンプト設計

3. **学習リソース**:
   - Azure APIの基本的な使い方の参考資料
   - RAGシステムのコンポーネント構成の理解
   - プロンプトエンジニアリングの基本的な例

> **注意**: このスクリプトは特定のインデックス構造を前提としており、そのままでは実働しません。Azure APIの呼び出し方法やRAG実装の参考資料としてご利用ください。実際に使用する場合は、ご自身の環境や検索インデックスに合わせた調整が必要です。実用的なRAG検索には`flexible_rag.py`を使用してください。

## flexible_rag.py - 汎用RAG検索ツール

`flexible_rag.py`は、様々なインデックス構造に対応した汎用的なRAG検索ツールです。Azure AI Searchのインデックスに対してRAG検索を実行し、動的にフィールド情報を取得して検索を行います。

### 基本的な使用方法

```bash
# インデックス一覧の表示
python flexible_rag.py --env-file .env --list-indexes

# 特定のインデックスのスキーマ表示
python flexible_rag.py --env-file .env --index "document-index" --schema

# すべてのインデックスのスキーマ表示
python flexible_rag.py --env-file .env --all-schemas

# 検索クエリの実行
python flexible_rag.py --env-file .env --index "document-index" --query "Azureの機能について"

# 対話的モード（インデックスと検索クエリを対話的に選択）
python flexible_rag.py --env-file .env
```

### コマンドラインオプション

#### 必須オプション
| オプション | 説明 | 影響 |
|-----------|------|------|
| `--env-file`, `-e` | 環境変数ファイルのパス（必須） | 指定されたファイルから環境変数を読み込みます。このファイルにはAzure AI SearchとAzure OpenAIの接続情報が含まれている必要があります。ファイルが存在しない場合やアクセス権限がない場合はエラーになります。 |

#### 基本的な検索オプション
| オプション | 説明 | 影響 |
|-----------|------|------|
| `--query`, `-q` | 検索クエリ | 入力された文字列に基づいて検索と回答生成を行います。自然言語の質問や検索キーワードを指定します。複雑な質問ほど回答の精度が高まりますが、検索に使われる単語が少なすぎると関連文書が見つからない場合があります。 |
| `--index`, `-i` | インデックス名 | 検索対象のAzure AI Searchインデックスを指定します。指定されたインデックスが存在しない場合はエラーになります。このオプションを省略すると、インタラクティブモードでインデックスの選択を求められます。 |
| `--list-indexes`, `-l` | インデックス一覧を表示 | 利用可能なすべてのインデックスを一覧表示します。これにより、どのインデックスが存在するか、どのインデックスを検索に使用すべきかを確認できます。 |
| `--schema`, `-s` | インデックスのスキーマを表示 | 指定されたインデックスのスキーマ情報（フィールド名、データ型、検索可能かどうかなど）を詳細に表示します。これによりインデックスの構造を理解し、適切な検索クエリを組み立てる助けになります。 |
| `--all-schemas`, `-a` | すべてのインデックスのスキーマを表示 | すべてのインデックスのスキーマ情報を一度に表示します。複数のインデックスの比較や、最適なインデックスの選択に役立ちます。 |
| `--top`, `-t` | 検索結果の最大数（デフォルト: 3） | 検索で返されるドキュメントの最大数を指定します。値を大きくすると（5-10）より多くの情報ソースが回答生成に使用され、網羅的な回答が得られますが、処理時間が長くなりトークン消費量も増えます。値を小さくすると（1-3）処理は速くなりますが、情報が限定される可能性があります。 |
| `--verbose`, `-v` | 詳細情報を表示 | テキストフィールドを切り詰めずに全て表示します。長い文書や詳細な情報が含まれているインデックスで検索する場合は、値を増やす（1500～2000）と効果的です。ただし、値が大きすぎると（3000以上）OpenAIのトークン制限に達する可能性があります。コンテキスト長はトークン消費量と直接関係するため、コスト効率を考慮して設定します。 |
| `--search-only`, `-so` | 検索のみ実行 | 検索結果のみを表示し、Azure OpenAIによる回答生成を行いません。これにより、OpenAI APIの使用量とコストを削減できます。RAGシステムのデバッグや、検索結果の品質確認にも役立ちます。 |

#### 詳細オプション
| オプション | 説明 | 影響 |
|-----------|------|------|
| `--temperature` | 生成モデルの温度（0.0～1.0、デフォルト: 0.7） | 生成される回答の創造性と確定性のバランスを制御します。低い値（0.1～0.3）では、より確定的で予測可能な回答が生成されます。高い値（0.7～1.0）では、より多様で創造的な回答が生成されます。事実ベースの質問には低い温度が適し、アイデア創出やブレインストーミングには高い温度が適しています。例えば、技術的な質問には0.2、創造的な提案を求める質問には0.8などと設定します。 |
| `--max-tokens` | 生成される最大トークン数（デフォルト: 500） | 生成される回答の最大長を制御します。値を大きくすると（800～1000）、より詳細で包括的な回答が得られますが、APIコストが増加します。値を小さくすると（100～300）、簡潔な回答が得られ、コストを抑えられます。一般的な質問応答には500程度、詳細な説明が必要な場合は800以上が適しています。 |
| `--max-context-length` | コンテキストフィールドの最大長（デフォルト: 1000） | 検索結果から回答生成に使用する文脈情報の各フィールドごとの最大文字数を指定します。長い文書や詳細な情報が含まれているインデックスで検索する場合は、値を増やす（1500～2000）と効果的です。ただし、値が大きすぎると（3000以上）OpenAIのトークン制限に達する可能性があります。コンテキスト長はトークン消費量と直接関係するため、コスト効率を考慮して設定します。 |
| `--summary-length` | 表示時のテキスト要約長（デフォルト: 300） | 検索結果の表示時に各フィールドの内容を切り詰める文字数です。長いテキストフィールドがある場合でも、コンソール表示を見やすく保つために使用します。値を大きくすると（500～1000）より多くの内容が表示されますが、画面が読みにくくなる場合があります。詳細をすべて表示したい場合は、`--verbose`オプションと組み合わせると効果的です。 |
| `--vector-exclude` | 検索から除外するベクトル埋め込みフィールドのパターン（デフォルト: "vector"） | ベクトル埋め込みフィールドをテキスト検索から除外するためのパターンです。埋め込みベクトルフィールドは通常の検索に使用するとエラーになるため、このパターンに一致するフィールド名は自動的に検索対象から除外されます。インデックスに異なる命名規則（"embedding"や"vector_content"など）が使用されている場合、このオプションで調整できます。適切に設定しないと検索エラーが発生する可能性があります。 |
| `--vector-type` | ベクトル埋め込みフィールドのデータ型パターン（デフォルト: "Collection(Edm.Single)"） | ベクトル埋め込みフィールドのデータ型パターンを指定します。Azure AI Searchでは環境によって異なるベクトル型が使用される場合があります。"Collection(Edm.Single)"や"Collection(Edm.Float32)"などのパターンを指定して、ベクトルフィールドを正確に識別できます。特にインデックスの取得でエラーが発生する場合に、このパターンを調整すると問題が解決することがあります。 |

### 主な特徴

1. **動的なインデックス対応**:
   - 様々なインデックス構造に自動適応
   - 検索可能フィールドの自動検出
   - ベクトル検索フィールドの対応

2. **高度な検索機能**:
   - ハイブリッド検索（テキスト+ベクトル）
   - フィールド優先度の動的調整
   - 詳細なパラメータ制御

3. **ユーザーフレンドリーな対話モード**:
   - インデックス選択の対話的インターフェース
   - スキーマ情報の視覚化
   - 検索結果の適応的な表示

> **実用的な使用**: このスクリプトは実際の運用環境で使用可能な設計になっています。様々なインデックス構造に対応し、インデックスのスキーマを自動的に解析して適切な検索を行います。
